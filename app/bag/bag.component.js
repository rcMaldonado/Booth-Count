"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("nativescript-angular/router");
var dialogs_1 = require("nativescript-angular/directives/dialogs");
var nativescript_fancyalert_1 = require("nativescript-fancyalert");
var bag_modal_1 = require("./bag.modal");
var total_modal_1 = require("./total.modal");
var Toast = require("nativescript-toasts");
var localStorage = require("nativescript-localstorage");
var Sqlite = require("nativescript-sqlite");
var BagComponent = /** @class */ (function () {
    // This pattern makes use of Angular’s dependency injection implementation to inject an instance of the ItemService service into this class. 
    // Angular knows about this service because it is included in your app’s main NgModule, defined in app.module.ts.
    function BagComponent(router, modal, vcRef) {
        this.router = router;
        this.modal = modal;
        this.vcRef = vcRef;
        this.salesId = localStorage.getItem("salesId");
        this.getSales();
    }
    BagComponent.prototype.ngOnInit = function () {
    };
    BagComponent.prototype.ngAfterViewInit = function () {
        this.createOrders();
        console.log("SalesId is: ", this.salesId);
    };
    BagComponent.prototype.goBack = function () {
        this.router.navigate(["main"], { clearHistory: true });
    };
    BagComponent.prototype.onItemTap = function (args) {
        var _this = this;
        var index = args.index;
        var selectedItem = {
            "name": this.sales[index].productName,
            "quantity": this.sales[index].quantityToSale,
            "salesId": this.sales[index].salesId,
            "vendorId": this.sales[index].vendorId,
            "productId": this.sales[index].productId,
            "price": this.sales[index].price
        };
        var editModalOptions = {
            context: { details: selectedItem },
            fullscreen: false,
            viewContainerRef: this.vcRef,
        };
        this.modal.showModal(bag_modal_1.ModalComponent, editModalOptions).then(function (data) {
            if (data.response === "updated") {
                _this.updateQuantityToSale(data.quantity, data.priceSum, data.salesId, data.vendorId, data.productId);
                _this.getSales();
            }
            else if (data.response === "delete") {
                _this.deleteSale(data.salesId, data.vendorId, data.productId);
                _this.getSales();
            }
        });
    };
    BagComponent.prototype.confirmSale = function () {
        var _this = this;
        var totalModalOptions = {
            context: { details: this.sales },
            fullscreen: false,
            viewContainerRef: this.vcRef,
        };
        this.modal.showModal(total_modal_1.TotalModalComponent, totalModalOptions).then(function (data) {
            if (data.response === "confirm") {
                _this.insertOrders(_this.salesId, data.total);
            }
            else if (data.response === "delete") {
                _this.emptyBag(_this.salesId);
            }
            else if (data.response === "cancel") {
                var title = "No Hay Productos";
                var message = "Para hacer una orden el bolso de contener productos a vender";
                var buttonText = "OK";
                nativescript_fancyalert_1.TNSFancyAlert.showWarning(title, message, buttonText).then(function () {
                    _this.router.navigate(["main"]);
                });
            }
        });
    };
    BagComponent.prototype.getSales = function () {
        var _this = this;
        (new Sqlite("booth.db")).then(function (db) {
            db.all("SELECT inventory.productCode, inventory.productName, sales.quantityToSale, inventory.productPrice, sales.priceSum, sales.salesId, sales.vendorId, sales.productId FROM sales, inventory WHERE sales.productId = inventory.id AND sales.salesId = " + _this.salesId).then(function (rows) {
                _this.sales = [];
                for (var row in rows) {
                    _this.sales.push({
                        "productCode": rows[row][0],
                        "productName": rows[row][1],
                        "quantityToSale": rows[row][2],
                        "price": rows[row][3],
                        "priceSum": rows[row][4],
                        "salesId": rows[row][5],
                        "vendorId": rows[row][6],
                        "productId": rows[row][7]
                    });
                }
                console.log(_this.sales);
                _this.database = db;
            }, function (error) {
                console.log("SELECT ERROR", error);
            });
        });
    };
    BagComponent.prototype.deleteSale = function (salesId, vendorId, productId) {
        var _this = this;
        this.database.execSQL("DELETE FROM sales WHERE salesId=" + salesId + " AND vendorId=" + vendorId + " AND productId=" + productId).then(function () {
            _this.database.execSQL("UPDATE inventory SET isVisible=0 WHERE id=" + productId).then(function () {
                var message = 'El Producto fue removido del bolso de ventas';
                var toastOptions = { text: message, duration: Toast.DURATION.SHORT };
                Toast.show(toastOptions);
            }, function (error) {
                console.log("UPDATE ERROR", error);
            });
        }, function (error) {
            console.log("DELETE ERROR: ", error);
        });
    };
    BagComponent.prototype.updateQuantityToSale = function (quantity, priceSum, salesId, vendorId, productId) {
        this.database.execSQL("UPDATE sales SET quantityToSale=" + quantity + ", priceSum=" + priceSum + " WHERE (salesId=" + salesId + ") AND (vendorId=" + vendorId + ") AND (productId=" + productId + ")").then(function () {
            console.log("Cantidad a vendor actializada");
        }, function (error) {
            console.log("UPDATE ERROR", error);
        });
    };
    BagComponent.prototype.emptyBag = function (salesId) {
        var _this = this;
        this.database.execSQL("DELETE FROM sales WHERE salesId=" + salesId).then(function () {
            _this.database.execSQL("UPDATE inventory SET isVisible=0").then(function () {
                var message = 'El Bolso de Ventas fue vaciado';
                var toastOptions = { text: message, duration: Toast.DURATION.SHORT };
                Toast.show(toastOptions);
                _this.router.navigate(["main"]);
            }, function (error) {
                console.log("UPDATE ERROR", error);
            });
        }, function (error) {
            console.log("DELETE ERROR: ", error);
        });
    };
    BagComponent.prototype.createOrders = function () {
        this.database.execSQL("CREATE TABLE IF NOT EXISTS orders(orderId INTEGER PRIMARY KEY AUTOINCREMENT, salesId INTEGER, totalPrice TEXT, FOREIGN KEY (salesId) REFERENCES sales(salesId) ON UPDATE CASCADE ON DELETE CASCADE)").then(function () {
            console.log("Success on creating orders");
        }, function (error) {
            console.log("CREATE TABLE ERROR", error);
        });
    };
    BagComponent.prototype.insertOrders = function (salesId, total) {
        var _this = this;
        this.database.execSQL("INSERT INTO orders (salesId, totalPrice) VALUES (?, ?)", [salesId, total]).then(function () {
            _this.updateBalance();
            _this.router.navigate(["confirm"]);
        }, function (error) {
            console.log("INSERT ERROR", error);
        });
    };
    BagComponent.prototype.updateBalance = function () {
        var _this = this;
        this.database.all("SELECT inventory.id, inventory.balance, sales.quantityToSale FROM sales, inventory WHERE sales.productId = inventory.id AND salesId = " + this.salesId).then(function (rows) {
            _this.balance = [];
            for (var row in rows) {
                _this.balance.push({
                    "productId": rows[row][0],
                    "productBalance": rows[row][1],
                    "quantityToReduce": rows[row][2]
                });
            }
            for (var i = 0; i < _this.balance.length; i++) {
                var newBalance = +(_this.balance[i].productBalance - _this.balance[i].quantityToReduce);
                _this.database.execSQL("UPDATE inventory SET balance=" + newBalance + " WHERE id=" + _this.balance[i].productId).then(function () {
                    console.log("Balance actualizado");
                }, function (error) {
                    console.log("UPDATE ERROR", error);
                });
            }
            console.log(_this.balance);
        }, function (error) {
            console.log("SELECT ERROR", error);
        });
    };
    BagComponent = __decorate([
        core_1.Component({
            selector: "bag",
            moduleId: module.id,
            templateUrl: "./bag.component.html",
            styleUrls: ["./bag.component.css"]
        }),
        __metadata("design:paramtypes", [router_1.RouterExtensions, dialogs_1.ModalDialogService, core_1.ViewContainerRef])
    ], BagComponent);
    return BagComponent;
}());
exports.BagComponent = BagComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFnLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJhZy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBbUY7QUFDbkYsc0RBQStEO0FBQy9ELG1FQUE2RTtBQUM3RSxtRUFBNkU7QUFDN0UseUNBQTZDO0FBQzdDLDZDQUFvRDtBQUVwRCwyQ0FBNkM7QUFDN0Msd0RBQTBEO0FBRzFELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBUzVDO0lBT0ksNklBQTZJO0lBQzdJLGlIQUFpSDtJQUNqSCxzQkFBb0IsTUFBd0IsRUFBVSxLQUF5QixFQUFVLEtBQXVCO1FBQTVGLFdBQU0sR0FBTixNQUFNLENBQWtCO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBb0I7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFrQjtRQUM1RyxJQUFJLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRiwrQkFBUSxHQUFSO0lBQ0EsQ0FBQztJQUVELHNDQUFlLEdBQWY7UUFDSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlDLENBQUM7SUFFTSw2QkFBTSxHQUFiO1FBQ0ksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFDLFlBQVksRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFTSxnQ0FBUyxHQUFoQixVQUFpQixJQUFJO1FBQXJCLGlCQTBCQztRQXpCRyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3ZCLElBQUksWUFBWSxHQUFHO1lBQ2YsTUFBTSxFQUFFLElBQUks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QUMscUJBQXFCLENBQUM7U0FDckMsQ0FBQzt5Q0FVOEIseUJBQWdCLEVBQWlCLDRCQUFrQixFQUFpQix1QkFBZ0I7T0FUdkcsWUFBWSxDQXVMeEI7SUFBRCxtQkFBQztDQUFBLEFBdkxELElBdUxDO0FBdkxZLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEFmdGVyVmlld0luaXQsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgUm91dGVyRXh0ZW5zaW9ucyB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7IE1vZGFsRGlhbG9nU2VydmljZSB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhci9kaXJlY3RpdmVzL2RpYWxvZ3NcIjtcbmltcG9ydCB7IFROU0ZhbmN5QWxlcnQsIFROU0ZhbmN5QWxlcnRCdXR0b24gfSBmcm9tICduYXRpdmVzY3JpcHQtZmFuY3lhbGVydCc7XG5pbXBvcnQgeyBNb2RhbENvbXBvbmVudCB9IGZyb20gXCIuL2JhZy5tb2RhbFwiO1xuaW1wb3J0IHsgVG90YWxNb2RhbENvbXBvbmVudCB9IGZyb20gXCIuL3RvdGFsLm1vZGFsXCI7XG5cbmltcG9ydCAqIGFzIFRvYXN0IGZyb20gJ25hdGl2ZXNjcmlwdC10b2FzdHMnO1xuaW1wb3J0ICogYXMgbG9jYWxTdG9yYWdlIGZyb20gXCJuYXRpdmVzY3JpcHQtbG9jYWxzdG9yYWdlXCI7XG5cblxudmFyIFNxbGl0ZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xuXG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiBcImJhZ1wiLFxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9iYWcuY29tcG9uZW50Lmh0bWxcIixcbiAgICBzdHlsZVVybHM6IFtcIi4vYmFnLmNvbXBvbmVudC5jc3NcIl1cbn0pXG5leHBvcnQgY2xhc3MgQmFnQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25Jbml0IHtcblxuICAgIHByaXZhdGUgZGF0YWJhc2U6IGFueTtcbiAgICBwdWJsaWMgc2FsZXM6IEFycmF5PGFueT47XG4gICAgcHVibGljIHNhbGVzSWQ6IE51bWJlcjtcblxuICAgIHB1YmxpYyBiYWxhbmNlOiBBcnJheTxhbnk+O1xuICAgIC8vIFRoaXMgcGF0dGVybiBtYWtlcyB1c2Ugb2YgQW5ndWxhcuKAmXMgZGVwZW5kZW5jeSBpbmplY3Rpb24gaW1wbGVtZW50YXRpb24gdG8gaW5qZWN0IGFuIGluc3RhbmNlIG9mIHRoZSBJdGVtU2VydmljZSBzZXJ2aWNlIGludG8gdGhpcyBjbGFzcy4gXG4gICAgLy8gQW5ndWxhciBrbm93cyBhYm91dCB0aGlzIHNlcnZpY2UgYmVjYXVzZSBpdCBpcyBpbmNsdWRlZCBpbiB5b3VyIGFwcOKAmXMgbWFpbiBOZ01vZHVsZSwgZGVmaW5lZCBpbiBhcHAubW9kdWxlLnRzLlxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXJFeHRlbnNpb25zLCBwcml2YXRlIG1vZGFsOiBNb2RhbERpYWxvZ1NlcnZpY2UsIHByaXZhdGUgdmNSZWY6IFZpZXdDb250YWluZXJSZWYpIHtcbiAgICAgICAgdGhpcy5zYWxlc0lkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJzYWxlc0lkXCIpO1xuICAgICAgICB0aGlzLmdldFNhbGVzKCk7XG4gICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIH1cblxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpe1xuICAgICAgICB0aGlzLmNyZWF0ZU9yZGVycygpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIlNhbGVzSWQgaXM6IFwiLCB0aGlzLnNhbGVzSWQpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGdvQmFjaygpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW1wibWFpblwiXSwge2NsZWFySGlzdG9yeTogdHJ1ZX0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkl0ZW1UYXAoYXJncykge1xuICAgICAgICBsZXQgaW5kZXggPSBhcmdzLmluZGV4O1xuICAgICAgICBsZXQgc2VsZWN0ZWRJdGVtID0ge1xuICAgICAgICAgICAgXCJuYW1lXCI6IHRoaXMuc2FsZXNbaW5kZXhdLnByb2R1Y3ROYW1lLFxuICAgICAgICAgICAgXCJxdWFudGl0eVwiOiB0aGlzLnNhbGVzW2luZGV4XS5xdWFudGl0eVRvU2FsZSxcbiAgICAgICAgICAgIFwic2FsZXNJZFwiOiB0aGlzLnNhbGVzW2luZGV4XS5zYWxlc0lkLFxuICAgICAgICAgICAgXCJ2ZW5kb3JJZFwiOiB0aGlzLnNhbGVzW2luZGV4XS52ZW5kb3JJZCxcbiAgICAgICAgICAgIFwicHJvZHVjdElkXCI6IHRoaXMuc2FsZXNbaW5kZXhdLnByb2R1Y3RJZCxcbiAgICAgICAgICAgIFwicHJpY2VcIjogdGhpcy5zYWxlc1tpbmRleF0ucHJpY2VcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgZWRpdE1vZGFsT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIGNvbnRleHQ6IHsgZGV0YWlsczogc2VsZWN0ZWRJdGVtfSxcbiAgICAgICAgICAgIGZ1bGxzY3JlZW46IGZhbHNlLFxuICAgICAgICAgICAgdmlld0NvbnRhaW5lclJlZjogdGhpcy52Y1JlZixcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLm1vZGFsLnNob3dNb2RhbChNb2RhbENvbXBvbmVudCwgZWRpdE1vZGFsT3B0aW9ucykudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgIGlmKGRhdGEucmVzcG9uc2UgPT09IFwidXBkYXRlZFwiKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVRdWFudGl0eVRvU2FsZShkYXRhLnF1YW50aXR5LCBkYXRhLnByaWNlU3VtLCBkYXRhLnNhbGVzSWQsIGRhdGEudmVuZG9ySWQsIGRhdGEucHJvZHVjdElkKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFNhbGVzKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYoZGF0YS5yZXNwb25zZSA9PT0gXCJkZWxldGVcIil7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVTYWxlKGRhdGEuc2FsZXNJZCwgZGF0YS52ZW5kb3JJZCwgZGF0YS5wcm9kdWN0SWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0U2FsZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbmZpcm1TYWxlKCkge1xuICAgICAgICBsZXQgdG90YWxNb2RhbE9wdGlvbnMgPSB7XG4gICAgICAgICAgICBjb250ZXh0OiB7IGRldGFpbHM6IHRoaXMuc2FsZXN9LFxuICAgICAgICAgICAgZnVsbHNjcmVlbjogZmFsc2UsXG4gICAgICAgICAgICB2aWV3Q29udGFpbmVyUmVmOiB0aGlzLnZjUmVmLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMubW9kYWwuc2hvd01vZGFsKFRvdGFsTW9kYWxDb21wb25lbnQsIHRvdGFsTW9kYWxPcHRpb25zKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgaWYoZGF0YS5yZXNwb25zZSA9PT0gXCJjb25maXJtXCIpe1xuICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0T3JkZXJzKHRoaXMuc2FsZXNJZCwgZGF0YS50b3RhbCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYoZGF0YS5yZXNwb25zZSA9PT0gXCJkZWxldGVcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1wdHlCYWcodGhpcy5zYWxlc0lkKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZihkYXRhLnJlc3BvbnNlID09PSBcImNhbmNlbFwiKXtcblxuICAgICAgICAgICAgICAgIGxldCB0aXRsZSA9IFwiTm8gSGF5IFByb2R1Y3Rvc1wiO1xuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0gXCJQYXJhIGhhY2VyIHVuYSBvcmRlbiBlbCBib2xzbyBkZSBjb250ZW5lciBwcm9kdWN0b3MgYSB2ZW5kZXJcIjtcbiAgICAgICAgICAgICAgICBsZXQgYnV0dG9uVGV4dCA9IFwiT0tcIjtcbiAgICAgICAgICAgICAgICBUTlNGYW5jeUFsZXJ0LnNob3dXYXJuaW5nKHRpdGxlLCBtZXNzYWdlLCBidXR0b25UZXh0KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW1wibWFpblwiXSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRTYWxlcygpIHtcbiAgICAgICAgKG5ldyBTcWxpdGUoXCJib290aC5kYlwiKSkudGhlbihkYiA9PiB7XG4gICAgICAgICAgICBkYi5hbGwoXCJTRUxFQ1QgaW52ZW50b3J5LnByb2R1Y3RDb2RlLCBpbnZlbnRvcnkucHJvZHVjdE5hbWUsIHNhbGVzLnF1YW50aXR5VG9TYWxlLCBpbnZlbnRvcnkucHJvZHVjdFByaWNlLCBzYWxlcy5wcmljZVN1bSwgc2FsZXMuc2FsZXNJZCwgc2FsZXMudmVuZG9ySWQsIHNhbGVzLnByb2R1Y3RJZCBGUk9NIHNhbGVzLCBpbnZlbnRvcnkgV0hFUkUgc2FsZXMucHJvZHVjdElkID0gaW52ZW50b3J5LmlkIEFORCBzYWxlcy5zYWxlc0lkID0gXCIgKyB0aGlzLnNhbGVzSWQpLnRoZW4ocm93cyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zYWxlcyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIHJvdyBpbiByb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBcInByb2R1Y3RDb2RlXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwicHJvZHVjdE5hbWVcIjogcm93c1tyb3ddWzFdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJxdWFudGl0eVRvU2FsZVwiOiByb3dzW3Jvd11bMl0sXG4gICAgICAgICAgICAgICAgICAgICAgICBcInByaWNlXCI6IHJvd3Nbcm93XVszXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwicHJpY2VTdW1cIjogcm93c1tyb3ddWzRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzYWxlc0lkXCI6IHJvd3Nbcm93XVs1XSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidmVuZG9ySWRcIjogcm93c1tyb3ddWzZdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJwcm9kdWN0SWRcIjogcm93c1tyb3ddWzddXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLnNhbGVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFiYXNlID0gZGI7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTRUxFQ1QgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZWxldGVTYWxlKHNhbGVzSWQsIHZlbmRvcklkLCBwcm9kdWN0SWQpIHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiREVMRVRFIEZST00gc2FsZXMgV0hFUkUgc2FsZXNJZD1cIiArIHNhbGVzSWQgKyBcIiBBTkQgdmVuZG9ySWQ9XCIgKyB2ZW5kb3JJZCArIFwiIEFORCBwcm9kdWN0SWQ9XCIgKyBwcm9kdWN0SWQpLnRoZW4oICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIlVQREFURSBpbnZlbnRvcnkgU0VUIGlzVmlzaWJsZT0wIFdIRVJFIGlkPVwiICsgcHJvZHVjdElkKS50aGVuKCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSAnRWwgUHJvZHVjdG8gZnVlIHJlbW92aWRvIGRlbCBib2xzbyBkZSB2ZW50YXMnO1xuICAgICAgICAgICAgICAgIGxldCB0b2FzdE9wdGlvbnM6IFRvYXN0LlRvYXN0T3B0aW9ucyA9IHsgdGV4dDogbWVzc2FnZSwgZHVyYXRpb246IFRvYXN0LkRVUkFUSU9OLlNIT1JUIH07XG4gICAgICAgICAgICAgICAgVG9hc3Quc2hvdyh0b2FzdE9wdGlvbnMpO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVVBEQVRFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRFTEVURSBFUlJPUjogXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZVF1YW50aXR5VG9TYWxlKHF1YW50aXR5LCBwcmljZVN1bSwgc2FsZXNJZCwgdmVuZG9ySWQsIHByb2R1Y3RJZCkge1xuICAgICAgICB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoXCJVUERBVEUgc2FsZXMgU0VUIHF1YW50aXR5VG9TYWxlPVwiICsgcXVhbnRpdHkgKyBcIiwgcHJpY2VTdW09XCIgKyBwcmljZVN1bSArIFwiIFdIRVJFIChzYWxlc0lkPVwiICsgc2FsZXNJZCArIFwiKSBBTkQgKHZlbmRvcklkPVwiICsgdmVuZG9ySWQgKyBcIikgQU5EIChwcm9kdWN0SWQ9XCIgKyBwcm9kdWN0SWQgKyBcIilcIikudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNhbnRpZGFkIGEgdmVuZG9yIGFjdGlhbGl6YWRhXCIpO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVQREFURSBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBlbXB0eUJhZyhzYWxlc0lkKSB7XG4gICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIkRFTEVURSBGUk9NIHNhbGVzIFdIRVJFIHNhbGVzSWQ9XCIgKyBzYWxlc0lkKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIlVQREFURSBpbnZlbnRvcnkgU0VUIGlzVmlzaWJsZT0wXCIpLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSAnRWwgQm9sc28gZGUgVmVudGFzIGZ1ZSB2YWNpYWRvJztcbiAgICAgICAgICAgICAgICBsZXQgdG9hc3RPcHRpb25zOiBUb2FzdC5Ub2FzdE9wdGlvbnMgPSB7IHRleHQ6IG1lc3NhZ2UsIGR1cmF0aW9uOiBUb2FzdC5EVVJBVElPTi5TSE9SVCB9O1xuICAgICAgICAgICAgICAgIFRvYXN0LnNob3codG9hc3RPcHRpb25zKTtcblxuICAgICAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtcIm1haW5cIl0pO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVVBEQVRFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRFTEVURSBFUlJPUjogXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZU9yZGVycygpIHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgb3JkZXJzKG9yZGVySWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULCBzYWxlc0lkIElOVEVHRVIsIHRvdGFsUHJpY2UgVEVYVCwgRk9SRUlHTiBLRVkgKHNhbGVzSWQpIFJFRkVSRU5DRVMgc2FsZXMoc2FsZXNJZCkgT04gVVBEQVRFIENBU0NBREUgT04gREVMRVRFIENBU0NBREUpXCIpLnRoZW4oICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3VjY2VzcyBvbiBjcmVhdGluZyBvcmRlcnNcIik7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ1JFQVRFIFRBQkxFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGluc2VydE9yZGVycyhzYWxlc0lkLCB0b3RhbCkge1xuICAgICAgICB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoXCJJTlNFUlQgSU5UTyBvcmRlcnMgKHNhbGVzSWQsIHRvdGFsUHJpY2UpIFZBTFVFUyAoPywgPylcIiwgW3NhbGVzSWQsIHRvdGFsXSkudGhlbiAoICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQmFsYW5jZSgpO1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW1wiY29uZmlybVwiXSk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU5TRVJUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZUJhbGFuY2UoKSB7XG4gICAgICAgIHRoaXMuZGF0YWJhc2UuYWxsKFwiU0VMRUNUIGludmVudG9yeS5pZCwgaW52ZW50b3J5LmJhbGFuY2UsIHNhbGVzLnF1YW50aXR5VG9TYWxlIEZST00gc2FsZXMsIGludmVudG9yeSBXSEVSRSBzYWxlcy5wcm9kdWN0SWQgPSBpbnZlbnRvcnkuaWQgQU5EIHNhbGVzSWQgPSBcIiArIHRoaXMuc2FsZXNJZCkudGhlbihyb3dzID0+IHtcbiAgICAgICAgICAgIHRoaXMuYmFsYW5jZSA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgcm93IGluIHJvd3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhbGFuY2UucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIFwicHJvZHVjdElkXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgXCJwcm9kdWN0QmFsYW5jZVwiOiByb3dzW3Jvd11bMV0sXG4gICAgICAgICAgICAgICAgICAgIFwicXVhbnRpdHlUb1JlZHVjZVwiOiByb3dzW3Jvd11bMl1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLmJhbGFuY2UubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGxldCBuZXdCYWxhbmNlID0gKyh0aGlzLmJhbGFuY2VbaV0ucHJvZHVjdEJhbGFuY2UgLSB0aGlzLmJhbGFuY2VbaV0ucXVhbnRpdHlUb1JlZHVjZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiVVBEQVRFIGludmVudG9yeSBTRVQgYmFsYW5jZT1cIiAgKyBuZXdCYWxhbmNlICsgXCIgV0hFUkUgaWQ9XCIgKyB0aGlzLmJhbGFuY2VbaV0ucHJvZHVjdElkKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJCYWxhbmNlIGFjdHVhbGl6YWRvXCIpO1xuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVUERBVEUgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5iYWxhbmNlKTtcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTRUxFQ1QgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9XG59Il19