"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("nativescript-angular/router");
var angular_1 = require("nativescript-ui-sidedrawer/angular");
var nativescript_fancyalert_1 = require("nativescript-fancyalert");
var localStorage = require("nativescript-localstorage");
var Toast = require("nativescript-toasts");
var dialogs = require("ui/dialogs");
var Sqlite = require("nativescript-sqlite");
var MainComponent = /** @class */ (function () {
    function MainComponent(_changeDetectionRef, router) {
        this._changeDetectionRef = _changeDetectionRef;
        this.router = router;
        this.sales = [];
        this.createInventory();
        this.createSales();
    }
    MainComponent.prototype.ngAfterViewInit = function () {
        this.drawer = this.drawerComponent.sideDrawer;
        this._changeDetectionRef.detectChanges();
    };
    MainComponent.prototype.ngOnInit = function () {
        this.vendor = localStorage.getItem("vendor");
        this.name = this.vendor.name;
        this.salesId = localStorage.getItem("salesId");
        this.fetch(); // Consigue todos los items del inventario (inventory table).
        this.getSales(); // Consigue todos los item de sales.
        console.log("SalesId is: ", this.salesId);
    };
    //Ejecutada cuando el usuario selecciona una celda.
    MainComponent.prototype.onItemTap = function (args) {
        var _this = this;
        var index = args.index;
        var selectedItem = {
            "productId": this.inventory[index].productId,
            "productCode": this.inventory[index].productCode,
            "productName": this.inventory[index].productName,
            "productCategory": this.inventory[index].productCategory,
            "productPrice": this.inventory[index].productPrice,
            "balance": this.inventory[index].balance,
            "quantity": 1
        };
        if (this.inventory[index].isVisible) {
            dialogs.confirm({
                title: "Eliminar del Bolso",
                message: "¿Desea eliminar el producto del bolso de compra?",
                okButtonText: "Si",
                cancelButtonText: "No"
            }).then(function (result) {
                if (result.valueOf()) {
                    _this.inventory[index].isVisible = 0;
                    _this.updateInventory(selectedItem.productId, _this.inventory[index].isVisible, selectedItem.quantity, selectedItem.productPrice);
                }
            });
        }
        else {
            dialogs.prompt({
                title: "Cantidad a Vender",
                message: "Entre la cantidad de productos que desea vender.",
                okButtonText: "Confirmar",
                cancelButtonText: "Cancelar",
                defaultText: selectedItem.quantity.toString(),
                inputType: dialogs.inputType.text,
            }).then(function (result) {
                // console.log("Dialog result: " + result.result + ", text: " + result.text);
                if (isNaN(+result.text) || result.text === "" || result.text === undefined) {
                    dialogs.confirm({
                        title: "Entre un valor númerico",
                        message: "Favor de entrar un valor númerico para que el producto sea añadido al bolso de ventas.",
                        okButtonText: "OK",
                    });
                }
                else {
                    if (result.result) {
                        selectedItem.quantity = +result.text;
                        _this.sales.push(selectedItem);
                        _this.inventory[index].isVisible = 1;
                        //Se actualiza el inventario indicando que el producto es deseado
                        _this.updateInventory(selectedItem.productId, _this.inventory[index].isVisible, selectedItem.quantity, selectedItem.productPrice);
                        console.log(_this.sales);
                    }
                }
            });
        }
    };
    MainComponent.prototype.createInventory = function () {
        var _this = this;
        (new Sqlite("booth.db")).then(function (db) {
            db.execSQL("CREATE TABLE IF NOT EXISTS inventory (id INTEGER PRIMARY KEY AUTOINCREMENT, productCode TEXT, productName TEXT, productCategory TEXT, productPrice TEXT, initialBalance INTEGER, balance INTEGER, isVisible INTEGER)").then(function (id) {
                _this.database = db;
                console.log("Success");
            }, function (error) {
                console.log("CREATE TABLE ERROR", error);
            });
        }, function (error) {
            console.log("OPEN DB ERROR", error);
        });
    };
    MainComponent.prototype.fetch = function () {
        var _this = this;
        this.database.all("SELECT * FROM inventory").then(function (rows) {
            _this.inventory = [];
            for (var row in rows) {
                _this.inventory.push({
                    "productId": rows[row][0],
                    "productCode": rows[row][1],
                    "productName": rows[row][2],
                    "productCategory": rows[row][3],
                    "productPrice": rows[row][4],
                    "initialBalance": rows[row][5],
                    "balance": rows[row][6],
                    "isVisible": rows[row][7],
                });
            }
            _this.arrayLength = _this.inventory.length;
        }, function (error) {
            console.log("SELECT ERROR", error);
        });
    };
    MainComponent.prototype.updateInventory = function (id, isVisible, quantity, price) {
        var _this = this;
        this.database.execSQL("UPDATE inventory SET isVisible = " + isVisible + " WHERE id = " + id).then(function () {
            console.log("Inventario Actualizado");
            if (isVisible === 1) {
                var priceSum = _this.getPriceSum(quantity, price);
                _this.insertToSales(id, quantity, priceSum);
                _this.getSales();
            }
            else {
                _this.deleteSale(id);
                _this.getSales();
            }
        }, function (error) {
            console.log("INSERT ERROR", error);
        });
    };
    /* Se crea la tabla sales en donde se estara guardando la información
    de las ventas que se estan haciendo al momento. Estas se convertiran en orden
    en el bolso de ventas. Esta función es llamada en el constructor. */
    MainComponent.prototype.createSales = function () {
        var _this = this;
        (new Sqlite("booth.db")).then(function (db) {
            var vendorId = "FOREIGN KEY (vendorId) REFERENCES vendor(vendorId) ON UPDATE CASCADE ON DELETE CASCADE, ";
            var productId = " FOREIGN KEY (productId) REFERENCES inventory(id) ON UPDATE CASCADE ON DELETE CASCADE, ";
            db.execSQL("CREATE TABLE IF NOT EXISTS sales (salesId INTEGER, vendorId INTEGER NOT NULL, productId INTEGER NOT NULL, quantityToSale INTEGER, priceSum  TEXT, " + vendorId + productId + " PRIMARY KEY (salesId, vendorId, productId))").then(function (id) {
                _this.database = db;
                console.log("Success");
            }, function (error) {
                console.log("CREATE TABLE ERROR", error);
            });
        }, function (error) {
            console.log("OPEN DB ERROR", error);
        });
    };
    MainComponent.prototype.getSales = function () {
        var _this = this;
        this.database.all("SELECT * FROM sales WHERE sales.salesId = " + this.salesId).then(function (rows) {
            _this.sales = [];
            for (var row in rows) {
                _this.sales.push({
                    "salesId": rows[row][0],
                    "vendorId": rows[row][1],
                    "productId": rows[row][2],
                    "quantityToSale": rows[row][3],
                    "priceSum": rows[row][4]
                });
            }
            console.log(_this.sales);
        }, function (error) {
            console.log("SELECT ERROR", error);
        });
    };
    MainComponent.prototype.insertToSales = function (productId, quantity, price) {
        var _this = this;
        this.database.execSQL("INSERT or IGNORE INTO sales (salesId, vendorId, productId, quantityToSale, priceSum) VALUES (?, ?, ?, ?, ?)", [this.salesId, this.vendor.vendorId, productId, quantity, price]).then(function () {
            var message = 'Producto añadido al bolso de ventas';
            var toastOptions = { text: message, duration: Toast.DURATION.SHORT };
            Toast.show(toastOptions);
            _this.getSales();
        }, function (error) {
            console.log("INSERT ERROR", error);
        });
    };
    MainComponent.prototype.deleteSale = function (productId) {
        this.database.execSQL("DELETE FROM sales WHERE productId=" + productId).then(function () {
            var message = 'Producto eliminado del bolso de ventas';
            var toastOptions = { text: message, duration: Toast.DURATION.SHORT };
            Toast.show(toastOptions);
        }, function (error) {
            console.log("INSERT ERROR", error);
        });
    };
    MainComponent.prototype.getPriceSum = function (quantity, price) {
        var total = +quantity * +price;
        return total;
    };
    MainComponent.prototype.openDrawer = function () {
        this.drawer.showDrawer();
    };
    MainComponent.prototype.onCloseDrawerTap = function () {
        this.drawer.closeDrawer();
    };
    MainComponent.prototype.orderBag = function () {
        if (this.sales.length === 0) {
            var title = "No Hay Productos";
            var message = "No hay productos en el bolso de venta, favor de seleccionar un producto para producir una orden.";
            var buttonTitle = "OK";
            nativescript_fancyalert_1.TNSFancyAlert.showWarning(title, message, buttonTitle);
        }
        else {
            this.router.navigate(["bag"]);
        }
    };
    MainComponent.prototype.toInicio = function () {
        this.router.navigate(['main'], { clearHistory: true });
    };
    MainComponent.prototype.toInventario = function () {
        this.router.navigate(['inventario'], { clearHistory: true });
    };
    MainComponent.prototype.toOrdenes = function () {
        this.router.navigate(['ordenes'], { clearHistory: true });
    };
    MainComponent.prototype.toAjustes = function () {
        this.router.navigate(['settings'], { clearHistory: true });
    };
    MainComponent.prototype.toAbout = function () {
        this.router.navigate(["about"], { clearHistory: true });
    };
    __decorate([
        core_1.ViewChild(angular_1.RadSideDrawerComponent),
        __metadata("design:type", angular_1.RadSideDrawerComponent)
    ], MainComponent.prototype, "drawerComponent", void 0);
    MainComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: "main",
            templateUrl: "./main.component.html",
            styleUrls: ["./main.component.css"]
        }),
        __metadata("design:paramtypes", [core_1.ChangeDetectorRef, router_1.RouterExtensions])
    ], MainComponent);
    return MainComponent;
}());
exports.MainComponent = MainComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtYWluLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUErRjtBQUUvRixzREFBK0Q7QUFDL0QsOERBQTRGO0FBQzVGLG1FQUE2RTtBQUU3RSx3REFBMEQ7QUFDMUQsMkNBQTZDO0FBQzdDLG9DQUFzQztBQUt0QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQVM1QztJQVdJLHVCQUFvQixtQkFBc0MsRUFBVSxNQUF3QjtRQUF4RSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQW1CO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBa0I7UUFKckYsVUFBSyxHQUFlLEVBQUUsQ0FBQztRQUsxQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFLRCx1Q0FBZSxHQUFmO1FBQ0ksSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQztRQUM5QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDN0MsQ0FBQztJQUVELGdDQUFRLEdBQVI7UUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsNkRBQTZEO1FBQzNFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLG9DQUFvQztRQUNyRCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsT0FBTyxD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QUFDO0lBQy9ELENBQUM7SUFFTSwrQkFBTyxHQUFkO1FBQ0ksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFwT2tDO1FBQWxDLGdCQUFTLENBQUMsZ0NBQXNCLENBQUM7a0NBQXlCLGdDQUFzQjswREFBQztJQWhCekUsYUFBYTtRQU56QixnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFdBQVcsRUFBRSx1QkFBdUI7WUFDcEMsU0FBUyxFQUFFLENBQUMsc0JBQXNCLENBQUM7U0FDdEMsQ0FBQzt5Q0FZMkMsd0JBQWlCLEVBQWtCLHlCQUFnQjtPQVhuRixhQUFhLENBcVB6QjtJQUFELG9CQUFDO0NBQUEsQUFyUEQsSUFxUEM7QUFyUFksc0NBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIFZpZXdDaGlsZCwgT25Jbml0LCBBZnRlclZpZXdJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5cbmltcG9ydCB7IFJvdXRlckV4dGVuc2lvbnMgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXIvcm91dGVyXCI7XG5pbXBvcnQgeyBSYWRTaWRlRHJhd2VyQ29tcG9uZW50LCBTaWRlRHJhd2VyVHlwZSB9IGZyb20gXCJuYXRpdmVzY3JpcHQtdWktc2lkZWRyYXdlci9hbmd1bGFyXCI7XG5pbXBvcnQgeyBUTlNGYW5jeUFsZXJ0LCBUTlNGYW5jeUFsZXJ0QnV0dG9uIH0gZnJvbSAnbmF0aXZlc2NyaXB0LWZhbmN5YWxlcnQnO1xuaW1wb3J0IHsgUmFkU2lkZURyYXdlciB9IGZyb20gJ25hdGl2ZXNjcmlwdC11aS1zaWRlZHJhd2VyJztcbmltcG9ydCAqIGFzIGxvY2FsU3RvcmFnZSBmcm9tIFwibmF0aXZlc2NyaXB0LWxvY2Fsc3RvcmFnZVwiO1xuaW1wb3J0ICogYXMgVG9hc3QgZnJvbSAnbmF0aXZlc2NyaXB0LXRvYXN0cyc7XG5pbXBvcnQgKiBhcyBkaWFsb2dzIGZyb20gXCJ1aS9kaWFsb2dzXCI7XG5cbmltcG9ydCB7IFZlbmRvciB9IGZyb20gXCIuLi9vYmplY3RzL3ZlbmRvclwiO1xuaW1wb3J0IHsgSW52ZW50b3J5IH0gZnJvbSBcIi4uL29iamVjdHMvaW52ZW50b3J5L2ludmVudG9yeVwiO1xuXG52YXIgU3FsaXRlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1zcWxpdGVcIik7XG5cblxuQENvbXBvbmVudCh7XG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICBzZWxlY3RvcjogXCJtYWluXCIsXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9tYWluLmNvbXBvbmVudC5odG1sXCIsXG4gICAgc3R5bGVVcmxzOiBbXCIuL21haW4uY29tcG9uZW50LmNzc1wiXVxufSlcbmV4cG9ydCBjbGFzcyBNYWluQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25Jbml0IHtcblxuICAgIHByaXZhdGUgZGF0YWJhc2U6IGFueTtcblxuICAgIHB1YmxpYyBpbnZlbnRvcnk6IEFycmF5PEludmVudG9yeT47XG4gICAgcHVibGljIHZlbmRvcjogVmVuZG9yO1xuICAgIHB1YmxpYyBuYW1lOiBTdHJpbmc7XG4gICAgcHVibGljIHNhbGVzOiBBcnJheTxhbnk+ID0gW107XG4gICAgcHVibGljIHNhbGVzSWQ6IE51bWJlcjtcbiAgICBwdWJsaWMgYXJyYXlMZW5ndGg7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jaGFuZ2VEZXRlY3Rpb25SZWY6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIHJvdXRlcjogUm91dGVyRXh0ZW5zaW9ucykge1xuICAgICAgICB0aGlzLmNyZWF0ZUludmVudG9yeSgpO1xuICAgICAgICB0aGlzLmNyZWF0ZVNhbGVzKCk7XG4gICAgfVxuXG4gICAgQFZpZXdDaGlsZChSYWRTaWRlRHJhd2VyQ29tcG9uZW50KSBwdWJsaWMgZHJhd2VyQ29tcG9uZW50OiBSYWRTaWRlRHJhd2VyQ29tcG9uZW50O1xuICAgIHByaXZhdGUgZHJhd2VyOiBSYWRTaWRlRHJhd2VyO1xuXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgICAgICB0aGlzLmRyYXdlciA9IHRoaXMuZHJhd2VyQ29tcG9uZW50LnNpZGVEcmF3ZXI7XG4gICAgICAgIHRoaXMuX2NoYW5nZURldGVjdGlvblJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMudmVuZG9yID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ2ZW5kb3JcIik7XG4gICAgICAgIHRoaXMubmFtZSA9IHRoaXMudmVuZG9yLm5hbWU7XG4gICAgICAgIHRoaXMuc2FsZXNJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwic2FsZXNJZFwiKTtcbiAgICAgICAgdGhpcy5mZXRjaCgpOyAvLyBDb25zaWd1ZSB0b2RvcyBsb3MgaXRlbXMgZGVsIGludmVudGFyaW8gKGludmVudG9yeSB0YWJsZSkuXG4gICAgICAgIHRoaXMuZ2V0U2FsZXMoKTsgLy8gQ29uc2lndWUgdG9kb3MgbG9zIGl0ZW0gZGUgc2FsZXMuXG4gICAgICAgIGNvbnNvbGUubG9nKFwiU2FsZXNJZCBpczogXCIsIHRoaXMuc2FsZXNJZCk7XG5cbiAgICB9XG5cbiAgICAvL0VqZWN1dGFkYSBjdWFuZG8gZWwgdXN1YXJpbyBzZWxlY2Npb25hIHVuYSBjZWxkYS5cbiAgICBwdWJsaWMgb25JdGVtVGFwKGFyZ3MpIHtcblxuICAgICAgICBsZXQgaW5kZXggPSBhcmdzLmluZGV4XG4gICAgICAgIGxldCBzZWxlY3RlZEl0ZW0gPSB7XG4gICAgICAgICAgICBcInByb2R1Y3RJZFwiOiB0aGlzLmludmVudG9yeVtpbmRleF0ucHJvZHVjdElkLFxuICAgICAgICAgICAgXCJwcm9kdWN0Q29kZVwiOiB0aGlzLmludmVudG9yeVtpbmRleF0ucHJvZHVjdENvZGUsXG4gICAgICAgICAgICBcInByb2R1Y3ROYW1lXCI6IHRoaXMuaW52ZW50b3J5W2luZGV4XS5wcm9kdWN0TmFtZSxcbiAgICAgICAgICAgIFwicHJvZHVjdENhdGVnb3J5XCI6IHRoaXMuaW52ZW50b3J5W2luZGV4XS5wcm9kdWN0Q2F0ZWdvcnksXG4gICAgICAgICAgICBcInByb2R1Y3RQcmljZVwiOiB0aGlzLmludmVudG9yeVtpbmRleF0ucHJvZHVjdFByaWNlLFxuICAgICAgICAgICAgXCJiYWxhbmNlXCI6IHRoaXMuaW52ZW50b3J5W2luZGV4XS5iYWxhbmNlLFxuICAgICAgICAgICAgXCJxdWFudGl0eVwiOiAxXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbnZlbnRvcnlbaW5kZXhdLmlzVmlzaWJsZSkge1xuICAgICAgICAgICAgZGlhbG9ncy5jb25maXJtKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJFbGltaW5hciBkZWwgQm9sc29cIixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIsK/RGVzZWEgZWxpbWluYXIgZWwgcHJvZHVjdG8gZGVsIGJvbHNvIGRlIGNvbXByYT9cIixcbiAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiU2lcIixcbiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIk5vXCJcbiAgICAgICAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnZhbHVlT2YoKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmludmVudG9yeVtpbmRleF0uaXNWaXNpYmxlID0gMDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVJbnZlbnRvcnkoc2VsZWN0ZWRJdGVtLnByb2R1Y3RJZCwgdGhpcy5pbnZlbnRvcnlbaW5kZXhdLmlzVmlzaWJsZSwgc2VsZWN0ZWRJdGVtLnF1YW50aXR5LCBzZWxlY3RlZEl0ZW0ucHJvZHVjdFByaWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRpYWxvZ3MucHJvbXB0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJDYW50aWRhZCBhIFZlbmRlclwiLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiRW50cmUgbGEgY2FudGlkYWQgZGUgcHJvZHVjdG9zIHF1ZSBkZXNlYSB2ZW5kZXIuXCIsXG4gICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIkNvbmZpcm1hclwiLFxuICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiQ2FuY2VsYXJcIixcbiAgICAgICAgICAgICAgICBkZWZhdWx0VGV4dDogc2VsZWN0ZWRJdGVtLnF1YW50aXR5LnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgaW5wdXRUeXBlOiBkaWFsb2dzLmlucHV0VHlwZS50ZXh0LFxuICAgICAgICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xuXG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJEaWFsb2cgcmVzdWx0OiBcIiArIHJlc3VsdC5yZXN1bHQgKyBcIiwgdGV4dDogXCIgKyByZXN1bHQudGV4dCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNOYU4oK3Jlc3VsdC50ZXh0KSB8fCByZXN1bHQudGV4dCA9PT0gXCJcIiB8fCByZXN1bHQudGV4dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ3MuY29uZmlybSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJFbnRyZSB1biB2YWxvciBuw7ptZXJpY29cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiRmF2b3IgZGUgZW50cmFyIHVuIHZhbG9yIG7Dum1lcmljbyBwYXJhIHF1ZSBlbCBwcm9kdWN0byBzZWEgYcOxYWRpZG8gYWwgYm9sc28gZGUgdmVudGFzLlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIk9LXCIsXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5yZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbS5xdWFudGl0eSA9ICtyZXN1bHQudGV4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2FsZXMucHVzaChzZWxlY3RlZEl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZlbnRvcnlbaW5kZXhdLmlzVmlzaWJsZSA9IDE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vU2UgYWN0dWFsaXphIGVsIGludmVudGFyaW8gaW5kaWNhbmRvIHF1ZSBlbCBwcm9kdWN0byBlcyBkZXNlYWRvXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUludmVudG9yeShzZWxlY3RlZEl0ZW0ucHJvZHVjdElkLCB0aGlzLmludmVudG9yeVtpbmRleF0uaXNWaXNpYmxlLCBzZWxlY3RlZEl0ZW0ucXVhbnRpdHksIHNlbGVjdGVkSXRlbS5wcm9kdWN0UHJpY2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5zYWxlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVJbnZlbnRvcnkoKSB7XG4gICAgICAgIChuZXcgU3FsaXRlKFwiYm9vdGguZGJcIikpLnRoZW4oZGIgPT4ge1xuICAgICAgICAgICAgZGIuZXhlY1NRTChcIkNSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGludmVudG9yeSAoaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULCBwcm9kdWN0Q29kZSBURVhULCBwcm9kdWN0TmFtZSBURVhULCBwcm9kdWN0Q2F0ZWdvcnkgVEVYVCwgcHJvZHVjdFByaWNlIFRFWFQsIGluaXRpYWxCYWxhbmNlIElOVEVHRVIsIGJhbGFuY2UgSU5URUdFUiwgaXNWaXNpYmxlIElOVEVHRVIpXCIpLnRoZW4oaWQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UgPSBkYjtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN1Y2Nlc3NcIik7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDUkVBVEUgVEFCTEUgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiT1BFTiBEQiBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmZXRjaCgpIHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5hbGwoXCJTRUxFQ1QgKiBGUk9NIGludmVudG9yeVwiKS50aGVuKHJvd3MgPT4ge1xuICAgICAgICAgICAgdGhpcy5pbnZlbnRvcnkgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIHJvdyBpbiByb3dzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnZlbnRvcnkucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIFwicHJvZHVjdElkXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgXCJwcm9kdWN0Q29kZVwiOiByb3dzW3Jvd11bMV0sXG4gICAgICAgICAgICAgICAgICAgIFwicHJvZHVjdE5hbWVcIjogcm93c1tyb3ddWzJdLFxuICAgICAgICAgICAgICAgICAgICBcInByb2R1Y3RDYXRlZ29yeVwiOiByb3dzW3Jvd11bM10sXG4gICAgICAgICAgICAgICAgICAgIFwicHJvZHVjdFByaWNlXCI6IHJvd3Nbcm93XVs0XSxcbiAgICAgICAgICAgICAgICAgICAgXCJpbml0aWFsQmFsYW5jZVwiOiByb3dzW3Jvd11bNV0sXG4gICAgICAgICAgICAgICAgICAgIFwiYmFsYW5jZVwiOiByb3dzW3Jvd11bNl0sXG4gICAgICAgICAgICAgICAgICAgIFwiaXNWaXNpYmxlXCI6IHJvd3Nbcm93XVs3XSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuYXJyYXlMZW5ndGggPSB0aGlzLmludmVudG9yeS5sZW5ndGg7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU0VMRUNUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZUludmVudG9yeShpZCwgaXNWaXNpYmxlLCBxdWFudGl0eSwgcHJpY2UpIHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiVVBEQVRFIGludmVudG9yeSBTRVQgaXNWaXNpYmxlID0gXCIgKyBpc1Zpc2libGUgKyBcIiBXSEVSRSBpZCA9IFwiICsgaWQpLnRoZW4oICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSW52ZW50YXJpbyBBY3R1YWxpemFkb1wiKTtcbiAgICAgICAgICAgIGlmIChpc1Zpc2libGUgPT09IDEpIHtcbiAgICAgICAgICAgICAgICBsZXQgcHJpY2VTdW0gPSB0aGlzLmdldFByaWNlU3VtKHF1YW50aXR5LCBwcmljZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRUb1NhbGVzKGlkLCBxdWFudGl0eSwgcHJpY2VTdW0pO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0U2FsZXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVTYWxlKGlkKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFNhbGVzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU5TRVJUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyogU2UgY3JlYSBsYSB0YWJsYSBzYWxlcyBlbiBkb25kZSBzZSBlc3RhcmEgZ3VhcmRhbmRvIGxhIGluZm9ybWFjacOzblxuICAgIGRlIGxhcyB2ZW50YXMgcXVlIHNlIGVzdGFuIGhhY2llbmRvIGFsIG1vbWVudG8uIEVzdGFzIHNlIGNvbnZlcnRpcmFuIGVuIG9yZGVuXG4gICAgZW4gZWwgYm9sc28gZGUgdmVudGFzLiBFc3RhIGZ1bmNpw7NuIGVzIGxsYW1hZGEgZW4gZWwgY29uc3RydWN0b3IuICovXG4gICAgcHVibGljIGNyZWF0ZVNhbGVzKCkge1xuICAgICAgICAobmV3IFNxbGl0ZShcImJvb3RoLmRiXCIpKS50aGVuKGRiID0+IHtcbiAgICAgICAgICAgIGxldCB2ZW5kb3JJZCA9IFwiRk9SRUlHTiBLRVkgKHZlbmRvcklkKSBSRUZFUkVOQ0VTIHZlbmRvcih2ZW5kb3JJZCkgT04gVVBEQVRFIENBU0NBREUgT04gREVMRVRFIENBU0NBREUsIFwiO1xuICAgICAgICAgICAgbGV0IHByb2R1Y3RJZCA9IFwiIEZPUkVJR04gS0VZIChwcm9kdWN0SWQpIFJFRkVSRU5DRVMgaW52ZW50b3J5KGlkKSBPTiBVUERBVEUgQ0FTQ0FERSBPTiBERUxFVEUgQ0FTQ0FERSwgXCI7XG4gICAgICAgICAgICBkYi5leGVjU1FMKFwiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgc2FsZXMgKHNhbGVzSWQgSU5URUdFUiwgdmVuZG9ySWQgSU5URUdFUiBOT1QgTlVMTCwgcHJvZHVjdElkIElOVEVHRVIgTk9UIE5VTEwsIHF1YW50aXR5VG9TYWxlIElOVEVHRVIsIHByaWNlU3VtICBURVhULCBcIiArIHZlbmRvcklkICsgcHJvZHVjdElkICsgXCIgUFJJTUFSWSBLRVkgKHNhbGVzSWQsIHZlbmRvcklkLCBwcm9kdWN0SWQpKVwiKS50aGVuKGlkID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFiYXNlID0gZGI7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdWNjZXNzXCIpO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ1JFQVRFIFRBQkxFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk9QRU4gREIgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0U2FsZXMoKSB7XG4gICAgICAgIHRoaXMuZGF0YWJhc2UuYWxsKFwiU0VMRUNUICogRlJPTSBzYWxlcyBXSEVSRSBzYWxlcy5zYWxlc0lkID0gXCIgKyB0aGlzLnNhbGVzSWQpLnRoZW4ocm93cyA9PiB7XG4gICAgICAgICAgICB0aGlzLnNhbGVzID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciByb3cgaW4gcm93cykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2FsZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIFwic2FsZXNJZFwiOiByb3dzW3Jvd11bMF0sXG4gICAgICAgICAgICAgICAgICAgIFwidmVuZG9ySWRcIjogcm93c1tyb3ddWzFdLFxuICAgICAgICAgICAgICAgICAgICBcInByb2R1Y3RJZFwiOiByb3dzW3Jvd11bMl0sXG4gICAgICAgICAgICAgICAgICAgIFwicXVhbnRpdHlUb1NhbGVcIjogcm93c1tyb3ddWzNdLFxuICAgICAgICAgICAgICAgICAgICBcInByaWNlU3VtXCI6IHJvd3Nbcm93XVs0XVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5zYWxlcyk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU0VMRUNUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGluc2VydFRvU2FsZXMocHJvZHVjdElkLCBxdWFudGl0eSwgcHJpY2UpIHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiSU5TRVJUIG9yIElHTk9SRSBJTlRPIHNhbGVzIChzYWxlc0lkLCB2ZW5kb3JJZCwgcHJvZHVjdElkLCBxdWFudGl0eVRvU2FsZSwgcHJpY2VTdW0pIFZBTFVFUyAoPywgPywgPywgPywgPylcIixcbiAgICAgICAgICAgIFt0aGlzLnNhbGVzSWQsIHRoaXMudmVuZG9yLnZlbmRvcklkLCBwcm9kdWN0SWQsIHF1YW50aXR5LCBwcmljZV0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0gJ1Byb2R1Y3RvIGHDsWFkaWRvIGFsIGJvbHNvIGRlIHZlbnRhcyc7XG4gICAgICAgICAgICAgICAgbGV0IHRvYXN0T3B0aW9uczogVG9hc3QuVG9hc3RPcHRpb25zID0geyB0ZXh0OiBtZXNzYWdlLCBkdXJhdGlvbjogVG9hc3QuRFVSQVRJT04uU0hPUlQgfTtcbiAgICAgICAgICAgICAgICBUb2FzdC5zaG93KHRvYXN0T3B0aW9ucyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmdldFNhbGVzKCk7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJJTlNFUlQgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZVNhbGUocHJvZHVjdElkKSB7XG4gICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIkRFTEVURSBGUk9NIHNhbGVzIFdIRVJFIHByb2R1Y3RJZD1cIiArIHByb2R1Y3RJZCwgKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gJ1Byb2R1Y3RvIGVsaW1pbmFkbyBkZWwgYm9sc28gZGUgdmVudGFzJztcbiAgICAgICAgICAgIGxldCB0b2FzdE9wdGlvbnM6IFRvYXN0LlRvYXN0T3B0aW9ucyA9IHsgdGV4dDogbWVzc2FnZSwgZHVyYXRpb246IFRvYXN0LkRVUkFUSU9OLlNIT1JUIH07XG4gICAgICAgICAgICBUb2FzdC5zaG93KHRvYXN0T3B0aW9ucyk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU5TRVJUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFByaWNlU3VtKHF1YW50aXR5LCBwcmljZSk6IE51bWJlciB7XG4gICAgICAgIGxldCB0b3RhbCA9ICtxdWFudGl0eSAqICtwcmljZTtcbiAgICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH1cblxuICAgIHB1YmxpYyBvcGVuRHJhd2VyKCkge1xuICAgICAgICB0aGlzLmRyYXdlci5zaG93RHJhd2VyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uQ2xvc2VEcmF3ZXJUYXAoKSB7XG4gICAgICAgIHRoaXMuZHJhd2VyLmNsb3NlRHJhd2VyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9yZGVyQmFnKCkge1xuICAgICAgICBpZiAodGhpcy5zYWxlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGxldCB0aXRsZSA9IFwiTm8gSGF5IFByb2R1Y3Rvc1wiO1xuICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSBcIk5vIGhheSBwcm9kdWN0b3MgZW4gZWwgYm9sc28gZGUgdmVudGEsIGZhdm9yIGRlIHNlbGVjY2lvbmFyIHVuIHByb2R1Y3RvIHBhcmEgcHJvZHVjaXIgdW5hIG9yZGVuLlwiO1xuICAgICAgICAgICAgbGV0IGJ1dHRvblRpdGxlID0gXCJPS1wiO1xuICAgICAgICAgICAgVE5TRmFuY3lBbGVydC5zaG93V2FybmluZyh0aXRsZSwgbWVzc2FnZSwgYnV0dG9uVGl0bGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW1wiYmFnXCJdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB0b0luaWNpbygpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydtYWluJ10sIHsgY2xlYXJIaXN0b3J5OiB0cnVlIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b0ludmVudGFyaW8oKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnaW52ZW50YXJpbyddLCB7IGNsZWFySGlzdG9yeTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9PcmRlbmVzKCkge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ29yZGVuZXMnXSwgeyBjbGVhckhpc3Rvcnk6IHRydWUgfSlcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9BanVzdGVzKCkge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ3NldHRpbmdzJ10sIHsgY2xlYXJIaXN0b3J5OiB0cnVlIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b0Fib3V0KCkge1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbXCJhYm91dFwiXSwgeyBjbGVhckhpc3Rvcnk6IHRydWV9KTtcbiAgICB9XG59Il19